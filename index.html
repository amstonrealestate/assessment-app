<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <title>Assisted Living Assessment App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    canvas { border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const { jsPDF } = window.jspdf;

    function App() {
      const [rates, setRates] = useState(() => {
        const savedRates = localStorage.getItem('rates');
        return savedRates ? JSON.parse(savedRates) : {
          moverHourly: 75,
          vehicleFlat: 50,
          mileageRate: 1,
          packingFee: 200,
          itemHandling: 0,
          materialsCost: 0,
          bubbleWrapCostPerFoot: 0.4,
          boxCost: 4,
          paperPadCostPerBox: 23.75,
          dishPackCost: 4.3,
        };
      });

      const [formData, setFormData] = useState({
        clientName: '',
        rooms: [
          {
            name: 'Living Room',
            width: '',
            length: '',
            furnitureItems: [],
            packingItems: [],
            photos: [],
            estimatedMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 },
            overrideMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 },
          }
        ],
        movers: 2,
        hoursLow: 4,
        hoursHigh: 5,
        vehicles: 1,
        mileage: 10,
        packing: false,
        materials: 0,
      });
      const canvasRef = useRef(null);
      const [selectedRoomIndex, setSelectedRoomIndex] = useState(0);
      const [model, setModel] = useState(null);
      const [loadingModel, setLoadingModel] = useState(true);
      const [itemCounter, setItemCounter] = useState(1);
      const [gapiLoaded, setGapiLoaded] = useState(false);
      const [gapiSignedIn, setGapiSignedIn] = useState(false);

      // Google Drive API credentials
      const CLIENT_ID = '534251225749-b7rjflroua415i616iopie6s09sp1isd.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCkVElXGRTtahGa140YDCW9d9JK7D0qhbQ';
      const SCOPES = 'https://www.googleapis.com/auth/drive.file';

      useEffect(() => {
        // Load Google API client
        window.gapi.load('client:auth2', () => {
          window.gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            scope: SCOPES,
          }).then(() => {
            setGapiLoaded(true);
            setGapiSignedIn(window.gapi.auth2.getAuthInstance().isSignedIn.get());
            window.gapi.auth2.getAuthInstance().isSignedIn.listen(setGapiSignedIn);
          }).catch(err => console.error('GAPI init failed:', err));
        });

        // Load COCO-SSD model
        cocoSsd.load().then(loadedModel => {
          setModel(loadedModel);
          setLoadingModel(false);
        }).catch(err => console.error('Model loading failed:', err));
      }, []);

      useEffect(() => {
        localStorage.setItem('rates', JSON.stringify(rates));
      }, [rates]);

      const handleInputChange = (e, roomIndex = null, itemIndex = null, field = null, type = 'furniture') => {
        if (roomIndex !== null && itemIndex === null) {
          const newRooms = [...formData.rooms];
          newRooms[roomIndex][e.target.name] = e.target.value;
          setFormData({ ...formData, rooms: newRooms });
        } else if (roomIndex !== null && itemIndex !== null && field) {
          const newRooms = [...formData.rooms];
          const itemList = type === 'furniture' ? newRooms[roomIndex].furnitureItems : newRooms[roomIndex].packingItems;
          itemList[itemIndex][field] = field === 'packingItem' ? e.target.checked : e.target.value;
          setFormData({ ...formData, rooms: newRooms });
        } else {
          setFormData({ ...formData, [e.target.name]: e.target.value });
        }
      };

      const handleOverrideChange = (e, roomIndex, field) => {
        const newRooms = [...formData.rooms];
        newRooms[roomIndex].overrideMaterials[field] = parseFloat(e.target.value) || 0;
        setFormData({ ...formData, rooms: newRooms });
      };

      const handleRateChange = (e) => {
        setRates({ ...rates, [e.target.name]: parseFloat(e.target.value) || 0 });
      };

      const addRoom = () => {
        setFormData({
          ...formData,
          rooms: [...formData.rooms, { name: '', width: '', length: '', furnitureItems: [], packingItems: [], photos: [], estimatedMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 }, overrideMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 } }],
        });
      };

      const addFurnitureItem = (roomIndex) => {
        const newRooms = [...formData.rooms];
        newRooms[roomIndex].furnitureItems.push({ id: `Item-${itemCounter}`, name: '', width: '', length: '', height: '', packingItem: false, photo: null });
        setFormData({ ...formData, rooms: newRooms });
        // Do not increment itemCounter here
      };

      const addPackingItem = (roomIndex) => {
        const newRooms = [...formData.rooms];
        newRooms[roomIndex].packingItems.push({ id: `Item-${itemCounter}`, name: '', width: '', length: '', height: '', packingItem: true });
        setFormData({ ...formData, rooms: newRooms });
        setItemCounter(itemCounter + 1);
      };

      const removeItem = (roomIndex, itemIndex, type = 'furniture') => {
        const newRooms = [...formData.rooms];
        const itemList = type === 'furniture' ? newRooms[roomIndex].furnitureItems : newRooms[roomIndex].packingItems;
        const item = itemList[itemIndex];
        if (item.photo) URL.revokeObjectURL(item.photo);
        itemList.splice(itemIndex, 1);
        setFormData({ ...formData, rooms: newRooms });
      };

      const handleRoomPhotoUpload = useCallback((e, roomIndex) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
          const newRooms = [...formData.rooms];
          const newPhotos = files.map(file => ({
            url: URL.createObjectURL(file),
            file
          }));
          newRooms[roomIndex].photos.push(...newPhotos);
          setFormData({ ...formData, rooms: newRooms });

          newPhotos.forEach((photo, index) => {
            if (photo.file.type.startsWith('image/')) {
              setTimeout(() => analyzeRoomPhoto(photo.url, roomIndex, true), (index + 1) * 1000);
            }
          });
        }
      }, [formData.rooms, model, loadingModel]);

  const handleFurniturePhotoUpload = useCallback((e, roomIndex, itemIndex) => {
  const file = e.target.files[0];
  if (!file) return;

  const newRooms = [...formData.rooms];
  const photoUrl = URL.createObjectURL(file);
  newRooms[roomIndex].furnitureItems[itemIndex].photo = photoUrl;
  setFormData({ ...formData, rooms: newRooms });

  setTimeout(() => analyzeFurniturePhoto(photoUrl, roomIndex, itemIndex), 1000);
}, [formData.rooms, model, loadingModel]);


      const removeRoomPhoto = (roomIndex, photoIndex) => {
        const newRooms = [...formData.rooms];
        const photo = newRooms[roomIndex].photos[photoIndex];
        if (photo.url) URL.revokeObjectURL(photo.url);
        newRooms[roomIndex].photos.splice(photoIndex, 1);
        newRooms[roomIndex].estimatedMaterials = { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 };
        newRooms[roomIndex].packingItems = [];
        newRooms[roomIndex].photos.forEach((photo, index) => {
          if (photo.file.type.startsWith('image/')) {
            setTimeout(() => analyzeRoomPhoto(photo.url, roomIndex, index > 0), (index + 1) * 1000);
          }
        });
        setFormData({ ...formData, rooms: newRooms });
      };

      const removeFurniturePhoto = (roomIndex, itemIndex) => {
        const newRooms = [...formData.rooms];
        const item = newRooms[roomIndex].furnitureItems[itemIndex];
        if (item.photo) URL.revokeObjectURL(item.photo);
        newRooms[roomIndex].furnitureItems[itemIndex].photo = null;
        newRooms[roomIndex].furnitureItems[itemIndex].file = null;
        setFormData({ ...formData, rooms: newRooms });
      };

      const analyzeRoomPhoto = async (photoUrl, roomIndex, aggregate = false) => {
        if (loadingModel || !model) return;

        try {
          const img = new Image();
          img.src = photoUrl;
          await new Promise(resolve => { img.onload = resolve; });

          const predictions = await model.detect(img);
          let dishCount = 0;
          let bookCount = 0;

          predictions.forEach(pred => {
            if (['cup', 'bowl', 'bottle', 'wine glass', 'fork', 'knife', 'spoon'].includes(pred.class)) {
              dishCount++;
            } else if (pred.class === 'book') {
              bookCount++;
            }
          });

          const dishPacks = Math.ceil(dishCount / 20);
          const paperPadBoxes = Math.ceil((dishCount * 4) / 25);
          const bubbleWrapFeet = dishCount * 2;
          const boxes = Math.ceil(dishCount / 20) + Math.ceil(bookCount / 30);

          const newRooms = [...formData.rooms];
          if (aggregate) {
            newRooms[roomIndex].estimatedMaterials.boxes += boxes;
            newRooms[roomIndex].estimatedMaterials.bubbleWrapFeet += bubbleWrapFeet;
            newRooms[roomIndex].estimatedMaterials.paperPadBoxes += paperPadBoxes;
            newRooms[roomIndex].estimatedMaterials.dishPacks += dishPacks;
          } else {
            newRooms[roomIndex].estimatedMaterials = { boxes, bubbleWrapFeet, paperPadBoxes, dishPacks };
          }

          if (!aggregate) {
            if (dishCount > 0) {
              newRooms[roomIndex].packingItems.push({ id: `Item-${itemCounter}`, name: `Detected Dishes (${dishCount})`, width: '', length: '', height: '', packingItem: true });
              setItemCounter(itemCounter + 1);
            }
            if (bookCount > 0) {
              newRooms[roomIndex].packingItems.push({ id: `Item-${itemCounter}`, name: `Detected Books (${bookCount})`, width: '', length: '', height: '', packingItem: true });
              setItemCounter(itemCounter + 1);
            }
          }
          setFormData({ ...formData, rooms: newRooms });
        } catch (err) {
          console.error('Photo analysis failed:', err);
          alert('Failed to analyze room photo. Try another image or use manual overrides.');
        } finally {
          URL.revokeObjectURL(photoUrl);
        }
      };

      const analyzeFurniturePhoto = async (photoUrl, roomIndex, itemIndex) => {
        if (loadingModel || !model) return;

        try {
          const img = new Image();
          img.src = photoUrl;
          await new Promise(resolve => { img.onload = resolve; });

          const predictions = await model.detect(img);
          let furnitureType = 'Dresser';
          let dimensions = { width: '3.5', length: '1.5', height: '3' };

          const furnitureClasses = ['bed', 'chair', 'couch', 'dining table', 'potted plant', 'tv'];
          const detected = predictions.find(pred => furnitureClasses.includes(pred.class));
          if (detected) {
            furnitureType = detected.class.charAt(0).toUpperCase() + detected.class.slice(1);
            switch (detected.class) {
              case 'bed': dimensions = { width: '6', length: '7', height: '2' }; break;
              case 'chair': dimensions = { width: '3', length: '3', height: '3' }; break;
              case 'couch': dimensions = { width: '7', length: '3', height: '3' }; break;
              case 'dining table': dimensions = { width: '6', length: '4', height: '3' }; break;
              case 'potted plant': dimensions = { width: '2', length: '2', height: '3' }; break;
              case 'tv': dimensions = { width: '4', length: '2', height: '3' }; break;
              default: dimensions = { width: '3.5', length: '1.5', height: '3' };
            }
          } else if (predictions.length > 0) {
            furnitureType = 'Dresser';
            dimensions = { width: '3.5', length: '1.5', height: '3' };
          }

          const newRooms = [...formData.rooms];
          newRooms[roomIndex].furnitureItems[itemIndex].name = `Detected ${furnitureType}`;
          newRooms[roomIndex].furnitureItems[itemIndex].width = dimensions.width;
          newRooms[roomIndex].furnitureItems[itemIndex].length = dimensions.length;
          newRooms[roomIndex].furnitureItems[itemIndex].height = dimensions.height;
          setFormData({ ...formData, rooms: newRooms });
        } catch (err) {
          console.error('Furniture photo analysis failed:', err);
          alert('Failed to analyze furniture photo. Edit item name and dimensions manually.');
        }
      };

      const saveToGoogleDrive = async () => {
        if (!gapiLoaded) {
          alert('Google API not loaded. Please try again later.');
          return;
        }

        if (!gapiSignedIn) {
          try {
            await window.gapi.auth2.getAuthInstance().signIn();
            setGapiSignedIn(true);
          } catch (err) {
            console.error('Google Sign-In failed:', err);
            alert('Failed to sign in to Google. Please try again.');
            return;
          }
        }

        try {
          // Create or find folder in Google Drive
          const folderName = `Assessment_${formData.clientName || 'Untitled'}_${Date.now()}`;
          let folderId;
          const folderSearch = await window.gapi.client.drive.files.list({
            q: `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id)'
          });

          if (folderSearch.result.files.length > 0) {
            folderId = folderSearch.result.files[0].id;
          } else {
            const folderMetadata = {
              name: folderName,
              mimeType: 'application/vnd.google-apps.folder'
            };
            const folderResponse = await window.gapi.client.drive.files.create({
              resource: folderMetadata,
              fields: 'id'
            });
            folderId = folderResponse.result.id;
          }

          // Collect all photos and videos
          const filesToUpload = [];
          formData.rooms.forEach((room, roomIndex) => {
            room.photos.forEach((photo, index) => {
              if (photo.file) {
                filesToUpload.push({
                  file: photo.file,
                  name: `${room.name || 'Room'}_${index + 1}.${photo.file.name.split('.').pop()}`
                });
              }
            });
            room.furnitureItems.forEach((item, index) => {
              if (item.file) {
                filesToUpload.push({
                  file: item.file,
                  name: `${room.name || 'Room'}_Item-${item.id}.${item.file.name.split('.').pop()}`
                });
              }
            });
          });

          // Upload or update files to Google Drive
          for (const { file, name } of filesToUpload) {
            // Check if file exists
            const fileSearch = await window.gapi.client.drive.files.list({
              q: `name='${name}' and '${folderId}' in parents and trashed=false`,
              fields: 'files(id)'
            });

            const metadata = {
              name,
              parents: fileSearch.result.files.length === 0 ? [folderId] : undefined
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            if (fileSearch.result.files.length > 0) {
              // Update existing file
              await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileSearch.result.files[0].id}?uploadType=multipart`, {
                method: 'PATCH',
                headers: {
                  Authorization: `Bearer ${window.gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                },
                body: form
              });
            } else {
              // Create new file
              await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${window.gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                },
                body: form
              });
            }
          }

          alert('All photos and videos uploaded/updated to Google Drive successfully!');
        } catch (err) {
          console.error('Upload to Google Drive failed:', err);
          alert('Failed to upload to Google Drive. Please check your internet connection or API permissions.');
        }
      };

      const calculateEstimate = () => {
        const totalItems = formData.rooms.reduce((sum, room) => sum + room.furnitureItems.length + room.packingItems.length, 0);
        let totalMaterialsCost = rates.materialsCost + (parseFloat(formData.materials) || 0);

        formData.rooms.forEach(room => {
          const mat = room.estimatedMaterials;
          const override = room.overrideMaterials;
          totalMaterialsCost += (mat.boxes + override.boxes) * rates.boxCost;
          totalMaterialsCost += (mat.bubbleWrapFeet + override.bubbleWrapFeet) * rates.bubbleWrapCostPerFoot;
          totalMaterialsCost += (mat.paperPadBoxes + override.paperPadBoxes) * rates.paperPadCostPerBox;
          totalMaterialsCost += (mat.dishPacks + override.dishPacks) * rates.dishPackCost;
        });

        const laborLow = formData.movers * rates.moverHourly * (parseFloat(formData.hoursLow) || 0);
        const laborHigh = formData.movers * rates.moverHourly * (parseFloat(formData.hoursHigh) || 0);
        const vehicleLow = formData.vehicles * rates.vehicleFlat + formData.mileage * rates.mileageRate;
        const vehicleHigh = vehicleLow * 1.2;
        const packingCost = formData.packing ? rates.packingFee : 0;
        const itemCost = totalItems * rates.itemHandling;
        const low = (laborLow + vehicleLow + packingCost + itemCost + totalMaterialsCost).toFixed(2);
        const high = (laborHigh + vehicleHigh + packingCost + itemCost + totalMaterialsCost).toFixed(2);
        return { low, high };
      };

      const generatePDF = () => {
        const { low, high } = calculateEstimate();
        const doc = new jsPDF();
        doc.text(`Quote for ${formData.clientName}`, 10, 10);
        doc.text(`Total Estimate: $${low} - $${high}`, 10, 20);
        doc.text(`Number of Movers: ${formData.movers}`, 10, 30);
        doc.text(`Labor Hours (Low/High): ${formData.hoursLow}/${formData.hoursHigh}`, 10, 40);
        doc.text(`Number of Vehicles: ${formData.vehicles}`, 10, 50);
        doc.text(`Mileage (miles): ${formData.mileage}`, 10, 60);
        doc.text(`Packing Service: ${formData.packing ? 'Yes' : 'No'}`, 10, 70);
        doc.text(`Additional Materials Cost: $${formData.materials}`, 10, 80);
        doc.text('Rooms:', 10, 90);
        let yPos = 100;
        formData.rooms.forEach((room, rIdx) => {
          doc.text(`${room.name} (${room.width}x${room.length} ft):`, 10, yPos);
          yPos += 10;
          doc.text('  Furniture Items:', 10, yPos);
          yPos += 10;
          room.furnitureItems.forEach((item, i) => {
            doc.text(`    - ${item.id}: ${item.name} (${item.width || 'N/A'}x${item.length || 'N/A'}x${item.height || 'N/A'})`, 10, yPos);
            yPos += 10;
          });
          doc.text('  Packing Items:', 10, yPos);
          yPos += 10;
          room.packingItems.forEach((item, i) => {
            doc.text(`    - ${item.id}: ${item.name} (${item.width || 'N/A'}x${item.length || 'N/A'}x${item.height || 'N/A'})`, 10, yPos);
            yPos += 10;
          });
          const mat = room.estimatedMaterials;
          const override = room.overrideMaterials;
          doc.text(`  Estimated Materials (Auto + Override): ${(mat.boxes + override.boxes)} boxes, ${(mat.bubbleWrapFeet + override.bubbleWrapFeet)} ft bubble wrap, ${(mat.paperPadBoxes + override.paperPadBoxes)} paper pad boxes, ${(mat.dishPacks + override.dishPacks)} dish packs`, 10, yPos);
          yPos += 10;
        });
        doc.save(`${formData.clientName}_quote.pdf`);
      };

      const exportToCSV = () => {
        const { low, high } = calculateEstimate();
        const headers = ['Client Name', 'Number of Movers', 'Labor Hours Low', 'Labor Hours High', 'Number of Vehicles', 'Mileage (miles)', 'Packing Service', 'Materials Cost', 'Total Low', 'Total High', 'Rooms'];
        const roomsStr = formData.rooms.map(room => 
          `${room.name} (${room.width}x${room.length}): Furniture - ${room.furnitureItems.map(item => `${item.id}: ${item.name} (${item.width || 'N/A'}x${item.length || 'N/A'}x${item.height || 'N/A'})`).join('; ')}; Packing - ${room.packingItems.map(item => `${item.id}: ${item.name} (${item.width || 'N/A'}x${item.length || 'N/A'}x${item.height || 'N/A'})`).join('; ')}; Materials - Boxes: ${room.estimatedMaterials.boxes + room.overrideMaterials.boxes}, Bubble: ${room.estimatedMaterials.bubbleWrapFeet + room.overrideMaterials.bubbleWrapFeet}ft, Paper Pads: ${room.estimatedMaterials.paperPadBoxes + room.overrideMaterials.paperPadBoxes}, Dish Packs: ${room.estimatedMaterials.dishPacks + room.overrideMaterials.dishPacks}`
        ).join(' | ');
        const row = [
          formData.clientName,
          formData.movers,
          formData.hoursLow,
          formData.hoursHigh,
          formData.vehicles,
          formData.mileage,
          formData.packing,
          formData.materials,
          low,
          high,
          roomsStr,
        ];
        const csv = [headers.join(','), row.join(',')].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${formData.clientName}_assessment.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const scale = 10;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const room = formData.rooms[selectedRoomIndex];
        if (!room) return;

        const roomWidth = parseFloat(room.width) * scale || 100;
        const roomLength = parseFloat(room.length) * scale || 100;
        ctx.strokeStyle = 'black';
        ctx.strokeRect(0, 0, roomWidth, roomLength);

        room.furnitureItems.forEach((item, i) => {
          if (item.packingItem) return;
          const width = parseFloat(item.width) * scale || 10;
          const length = parseFloat(item.length) * scale || 10;
          ctx.fillStyle = `hsl(${i * 60}, 50%, 50%)`;
          ctx.fillRect(10 + i * 20, 10 + i * 20, width, length);
          ctx.fillStyle = 'white';
          ctx.fillText(`${item.id}: ${item.name}`, 12 + i * 20, 20 + i * 20);
        });
      }, [formData.rooms, selectedRoomIndex]);

      return (
        <div className="p-4 max-w-md mx-auto bg-gray-100 min-h-screen">
          <h1 className="text-2xl font-bold mb-4">Assessment App</h1>

          <div className="mb-6 p-4 border rounded bg-white">
            <h2 className="text-lg font-semibold mb-2">Configuration Settings</h2>
            <p className="text-sm text-gray-600 mb-2">Adjust rates (saved locally for future use)</p>
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block text-sm font-medium">Mover Hourly Rate ($)</label>
                <input type="number" name="moverHourly" value={rates.moverHourly} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Vehicle Flat Cost ($)</label>
                <input type="number" name="vehicleFlat" value={rates.vehicleFlat} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Mileage Rate ($/mile)</label>
                <input type="number" name="mileageRate" value={rates.mileageRate} onChange={handleRateChange} className="w-full p-2 border rounded" step="0.01" />
              </div>
              <div>
                <label className="block text-sm font-medium">Packing Flat Fee ($)</label>
                <input type="number" name="packingFee" value={rates.packingFee} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Per Item Handling ($)</label>
                <input type="number" name="itemHandling" value={rates.itemHandling} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Base Materials Cost ($)</label>
                <input type="number" name="materialsCost" value={rates.materialsCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Bubble Wrap Cost (/ft)</label>
                <input type="number" name="bubbleWrapCostPerFoot" value={rates.bubbleWrapCostPerFoot} onChange={handleRateChange} className="w-full p-2 border rounded" step="0.01" />
              </div>
              <div>
                <label className="block text-sm font-medium">Box Cost ($)</label>
                <input type="number" name="boxCost" value={rates.boxCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Paper Pad Cost (/box)</label>
                <input type="number" name="paperPadCostPerBox" value={rates.paperPadCostPerBox} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Dish Pack Cost ($)</label>
                <input type="number" name="dishPackCost" value={rates.dishPackCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
            </div>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-medium">Client Name</label>
            <input
              type="text"
              name="clientName"
              value={formData.clientName}
              onChange={handleInputChange}
              className="w-full p-2 border rounded"
              placeholder="Enter client name"
              required
            />
          </div>

          <div className="mb-4">
            <h2 className="text-lg font-semibold mb-2">Rooms in New Space</h2>
            {formData.rooms.map((room, roomIndex) => (
              <div key={roomIndex} className="mb-4 p-4 border rounded bg-white">
                <input
                  type="text"
                  name="name"
                  value={room.name}
                  onChange={(e) => handleInputChange(e, roomIndex)}
                  className="w-full p-2 border rounded mb-2"
                  placeholder="Room Name (e.g., Living Room)"
                  required
                />
                <div className="flex gap-2 mb-2">
                  <input
                    type="number"
                    name="width"
                    value={room.width}
                    onChange={(e) => handleInputChange(e, roomIndex)}
                    className="w-1/2 p-2 border rounded"
                    placeholder="Width (ft) - optional"
                  />
                  <input
                    type="number"
                    name="length"
                    value={room.length}
                    onChange={(e) => handleInputChange(e, roomIndex)}
                    className="w-1/2 p-2 border rounded"
                    placeholder="Length (ft) - optional"
                  />
                </div>

                <div className="mb-2">
                  <label className="block text-sm font-medium">Upload Room Photo(s)/Video(s) (for packing items like dishes)</label>
                  <input
                    type="file"
                    accept="image/*,video/*"
                    multiple
                    onChange={(e) => handleRoomPhotoUpload(e, roomIndex)}
                    className="w-full p-2 border rounded"
                  />
                </div>

                {room.photos.length > 0 && (
                  <div className="grid grid-cols-3 gap-2 mb-2">
                    {room.photos.map((photo, photoIndex) => (
                      <div key={photoIndex} className="relative">
                        {photo.file.type.startsWith('video/') ? (
                          <video src={photo.url} controls className="w-full h-20 object-cover rounded" />
                        ) : (
                          <img src={photo.url} alt={`Room Media ${photoIndex + 1}`} className="w-full h-20 object-cover rounded" />
                        )}
                        <button
                          onClick={() => removeRoomPhoto(roomIndex, photoIndex)}
                          className="absolute top-0 right-0 bg-red-500 text-white px-1 py-0.5 text-xs rounded"
                        >
                          Remove
                        </button>
                      </div>
                    ))}
                  </div>
                )}

                <div className="mb-2 text-sm">
                  Auto-Estimated Materials: {room.estimatedMaterials.boxes} boxes, {room.estimatedMaterials.bubbleWrapFeet} ft bubble wrap, {room.estimatedMaterials.paperPadBoxes} paper pad boxes, {room.estimatedMaterials.dishPacks} dish packs
                </div>

                <div className="mb-2">
                  <h3 className="text-md font-medium mb-1">Manual Material Overrides (Add/Adjust)</h3>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <label className="block text-sm">Boxes</label>
                      <input
                        type="number"
                        value={room.overrideMaterials.boxes}
                        onChange={(e) => handleOverrideChange(e, roomIndex, 'boxes')}
                        className="w-full p-1 border rounded"
                        placeholder="0"
                      />
                    </div>
                    <div>
                      <label className="block text-sm">Bubble Wrap (ft)</label>
                      <input
                        type="number"
                        value={room.overrideMaterials.bubbleWrapFeet}
                        onChange={(e) => handleOverrideChange(e, roomIndex, 'bubbleWrapFeet')}
                        className="w-full p-1 border rounded"
                        placeholder="0"
                      />
                    </div>
                    <div>
                      <label className="block text-sm">Paper Pad Boxes</label>
                      <input
                        type="number"
                        value={room.overrideMaterials.paperPadBoxes}
                        onChange={(e) => handleOverrideChange(e, roomIndex, 'paperPadBoxes')}
                        className="w-full p-1 border rounded"
                        placeholder="0"
                      />
                    </div>
                    <div>
                      <label className="block text-sm">Dish Packs</label>
                      <input
                        type="number"
                        value={room.overrideMaterials.dishPacks}
                        onChange={(e) => handleOverrideChange(e, roomIndex, 'dishPacks')}
                        className="w-full p-1 border rounded"
                        placeholder="0"
                      />
                    </div>
                  </div>
                </div>

                <h3 className="text-md font-medium mb-1">Furniture Items (e.g., sofas, beds)</h3>
                {room.furnitureItems.map((item, itemIndex) => (
                  <div key={itemIndex} className="mb-2 p-2 border rounded flex items-center gap-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-sm font-medium">{item.id}</span>
                        <input
                          type="text"
                          placeholder="Item name (e.g., Sofa, Bed)"
                          value={item.name}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'name', 'furniture')}
                          className="w-full p-1 border rounded"
                          required
                        />
                      </div>
                      {item.name.startsWith('Detected') && (
                        <p className="text-xs text-gray-500">Auto-detected item (edit name/dimensions if needed)</p>
                      )}
                      <div className="flex gap-2 mb-1">
                        <input
                          type="number"
                          placeholder="Width (ft) - optional"
                          value={item.width}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'width', 'furniture')}
                          className="w-1/3 p-1 border rounded"
                        />
                        <input
                          type="number"
                          placeholder="Length (ft) - optional"
                          value={item.length}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'length', 'furniture')}
                          className="w-1/3 p-1 border rounded"
                        />
                        <input
                          type="number"
                          placeholder="Height (ft) - optional"
                          value={item.height}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'height', 'furniture')}
                          className="w-1/3 p-1 border rounded"
                        />
                      </div>
                      <div className="mb-1">
                        <label className="block text-sm font-medium">Upload Furniture Photo/Video</label>
                        <input
                          type="file"
                          accept="image/*,video/*"
                          multiple
                          onChange={(e) => handleFurniturePhotoUpload(e, roomIndex, itemIndex)}
                          className="w-full p-1 border rounded"
                        />
                      </div>
                      {item.photo && (
                        <div className="relative w-20 h-20">
                          {item.file && item.file.type.startsWith('video/') ? (
                            <video src={item.photo} controls className="w-full h-full object-cover rounded" />
                          ) : (
                            <img src={item.photo} alt="Furniture" className="w-full h-full object-cover rounded" />
                          )}
                          <button
                            onClick={() => removeFurniturePhoto(roomIndex, itemIndex)}
                            className="absolute top-0 right-0 bg-red-500 text-white px-1 py-0.5 text-xs rounded"
                          >
                            Remove
                          </button>
                        </div>
                      )}
                      <label className="flex items-center mt-1 text-sm">
                        <input
                          type="checkbox"
                          checked={item.packingItem}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'packingItem', 'furniture')}
                          className="mr-2"
                        />
                        Move to Packing Items (e.g., small items)
                      </label>
                    </div>
                    <button
                      onClick={() => removeItem(roomIndex, itemIndex, 'furniture')}
                      className="bg-red-500 text-white px-2 py-1 rounded text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
                <button
                  onClick={() => addFurnitureItem(roomIndex)}
                  className="bg-blue-500 text-white px-4 py-2 rounded mt-2"
                >
                  Add Furniture Item to {room.name || 'this Room'}
                </button>

                <h3 className="text-md font-medium mb-1 mt-4">Packing Items (e.g., dishes, books)</h3>
                {room.packingItems.map((item, itemIndex) => (
                  <div key={itemIndex} className="mb-2 p-2 border rounded flex items-center gap-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-sm font-medium">{item.id}</span>
                        <input
                          type="text"
                          placeholder="Item name (e.g., Dishes, Books)"
                          value={item.name}
                          onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'name', 'packing')}
                          className="w-full p-1 border rounded"
                          required
                        />
                      </div>
                      {item.name.startsWith('Detected') && (
                        <p className="text-xs text-gray-500">Auto-detected item (edit name if needed)</p>
                      )}
                    </div>
                    <button
                      onClick={() => removeItem(roomIndex, itemIndex, 'packing')}
                      className="bg-red-500 text-white px-2 py-1 rounded text-sm"
                    >
                      Remove
                    </button>
                  </div>
                ))}
                <button
                  onClick={() => addPackingItem(roomIndex)}
                  className="bg-blue-500 text-white px-4 py-2 rounded mt-2"
                >
                  Add Packing Item to {room.name || 'this Room'}
                </button>
              </div>
            ))}
            <button
              onClick={addRoom}
              className="bg-green-500 text-white px-4 py-2 rounded"
            >
              Add New Room
            </button>
          </div>

          <div className="mb-4">
            <h2 className="text-lg font-semibold">Estimate Details</h2>
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block text-sm font-medium">Number of Movers</label>
                <input
                  type="number"
                  name="movers"
                  value={formData.movers}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Movers"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Number of Vehicles</label>
                <input
                  type="number"
                  name="vehicles"
                  value={formData.vehicles}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Vehicles"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Labor Hours Low</label>
                <input
                  type="number"
                  name="hoursLow"
                  value={formData.hoursLow}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Low Hours"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Labor Hours High</label>
                <input
                  type="number"
                  name="hoursHigh"
                  value={formData.hoursHigh}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="High Hours"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Mileage (miles)</label>
                <input
                  type="number"
                  name="mileage"
                  value={formData.mileage}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Mileage"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Additional Materials Cost ($)</label>
                <input
                  type="number"
                  name="materials"
                  value={formData.materials}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Materials"
                />
              </div>
            </div>
            <label className="flex items-center mt-2">
              <input
                type="checkbox"
                name="packing"
                checked={formData.packing}
                onChange={(e) => setFormData({ ...formData, packing: e.target.checked })}
                className="mr-2"
              />
              Packing Service Needed
            </label>
          </div>

          <div className="mb-4">
            <h2 className="text-lg font-semibold">Room Visualization</h2>
            <select
              value={selectedRoomIndex}
              onChange={(e) => setSelectedRoomIndex(parseInt(e.target.value))}
              className="w-full p-2 border rounded mb-2"
            >
              {formData.rooms.map((room, index) => (
                <option key={index} value={index}>
                  {room.name || `Room ${index + 1}`}
                </option>
              ))}
            </select>
            <canvas ref={canvasRef} width="300" height="300" className="w-full"></canvas>
            <p className="text-sm text-gray-600">Preview of furniture items in selected room (colored rectangles). Packing items (e.g., dishes) are excluded.</p>
          </div>

          <div className="mb-4">
            <h2 className="text-lg font-semibold">Estimate: ${calculateEstimate().low} - ${calculateEstimate().high}</h2>
            <div className="flex gap-2">
              <button
                onClick={generatePDF}
                className="bg-green-500 text-white px-4 py-2 rounded"
              >
                Download Quote PDF
              </button>
              <button
                onClick={exportToCSV}
                className="bg-gray-500 text-white px-4 py-2 rounded"
              >
                Export to CSV
              </button>
              <button
                onClick={saveToGoogleDrive}
                className="bg-blue-500 text-white px-4 py-2 rounded"
                disabled={!gapiLoaded}
              >
                Save to Google Drive
              </button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>