<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <title>Assisted Living Assessment App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <link rel="manifest" href='data:application/manifest+json,{
    "name": "Assessment App",
    "short_name": "Assessment",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#ffffff"
  }'>
  <style>
    canvas { border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { jsPDF } = window.jspdf;

    function App() {
      // State for configurable rates (persisted in localStorage, defaults from spreadsheet resale)
      const [rates, setRates] = useState(() => {
        const savedRates = localStorage.getItem('rates');
        return savedRates ? JSON.parse(savedRates) : {
          moverHourly: 75,
          vehicleFlat: 50,
          mileageRate: 1,
          packingFee: 200,
          itemHandling: 0,
          materialsCost: 0,
          bubbleWrapCostPerFoot: 0.4,
          boxCost: 4,
          paperPadCostPerBox: 23.75,
          dishPackCost: 4.3,
        };
      });

      // State for assessment data
      const [formData, setFormData] = useState({
        clientName: '',
        rooms: [
          {
            name: 'Living Room',
            width: '',
            length: '',
            items: [],
            photo: null,
            estimatedMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 },
          }
        ],
        movers: 2,
        hoursLow: 4,
        hoursHigh: 5,
        vehicles: 1,
        mileage: 10,
        packing: false,
        materials: 0,
      });
      const canvasRef = useRef(null);
      const [selectedRoomIndex, setSelectedRoomIndex] = useState(0);
      const [model, setModel] = useState(null);
      const [loadingModel, setLoadingModel] = useState(true);

      // Load COCO-SSD model on mount
      useEffect(() => {
        cocoSsd.load().then(loadedModel => {
          setModel(loadedModel);
          setLoadingModel(false);
        });
      }, []);

      // Persist rates to localStorage
      useEffect(() => {
        localStorage.setItem('rates', JSON.stringify(rates));
      }, [rates]);

      // Update form data
      const handleInputChange = (e, roomIndex = null, itemIndex = null, field = null) => {
        if (roomIndex !== null && itemIndex === null) {
          const newRooms = [...formData.rooms];
          newRooms[roomIndex][e.target.name] = e.target.value;
          setFormData({ ...formData, rooms: newRooms });
        } else if (roomIndex !== null && itemIndex !== null && field) {
          const newRooms = [...formData.rooms];
          newRooms[roomIndex].items[itemIndex][field] = e.target.value;
          setFormData({ ...formData, rooms: newRooms });
        } else {
          setFormData({ ...formData, [e.target.name]: e.target.value });
        }
      };

      // Update rates
      const handleRateChange = (e) => {
        setRates({ ...rates, [e.target.name]: parseFloat(e.target.value) || 0 });
      };

      // Add new room
      const addRoom = () => {
        setFormData({
          ...formData,
          rooms: [...formData.rooms, { name: '', width: '', length: '', items: [], photo: null, estimatedMaterials: { boxes: 0, bubbleWrapFeet: 0, paperPadBoxes: 0, dishPacks: 0 } }],
        });
      };

      // Add new item to a specific room
      const addItemToRoom = (roomIndex) => {
        const newRooms = [...formData.rooms];
        newRooms[roomIndex].items.push({ name: '', width: '', length: '', height: '' });
        setFormData({ ...formData, rooms: newRooms });
      };

      // Handle photo upload for a room
      const handlePhotoUpload = (e, roomIndex) => {
        const file = e.target.files[0];
        if (file) {
          const photoUrl = URL.createObjectURL(file);
          const newRooms = [...formData.rooms];
          newRooms[roomIndex].photo = photoUrl;
          setFormData({ ...formData, rooms: newRooms });

          // Automatically analyze after upload
          setTimeout(() => analyzePhoto(roomIndex), 1000); // Delay to ensure image loaded
        }
      };

      // Analyze photo for materials (using COCO-SSD)
      const analyzePhoto = async (roomIndex) => {
        if (loadingModel || !model) return;

        const room = formData.rooms[roomIndex];
        if (!room.photo) return;

        const img = new Image();
        img.src = room.photo;
        await new Promise(resolve => { img.onload = resolve; });

        const predictions = await model.detect(img);

        // Count dish-related objects
        let dishCount = 0;
        predictions.forEach(pred => {
          if (['cup', 'bowl', 'bottle', 'wine glass', 'fork', 'knife', 'spoon'].includes(pred.class)) {
            dishCount++;
          }
        });

        // Refined estimates based on research
        const dishPacks = Math.ceil(dishCount / 20); // ~20 dishes per dish pack/box
        const paperPadBoxes = Math.ceil((dishCount * 4) / 25); // 4 sheets per dish, 25 sheets per box
        const bubbleWrapFeet = dishCount * 2; // ~2 ft per dish if using bubble wrap
        const boxes = Math.ceil(dishCount / 20); // General boxes, or align with dishPacks

        const newRooms = [...formData.rooms];
        newRooms[roomIndex].estimatedMaterials = { boxes, bubbleWrapFeet, paperPadBoxes, dishPacks };
        setFormData({ ...formData, rooms: newRooms });
      };

      // Calculate estimate using configurable rates and low/high logic, including materials
      const calculateEstimate = () => {
        const totalItems = formData.rooms.reduce((sum, room) => sum + room.items.length, 0);
        let totalMaterialsCost = rates.materialsCost + (parseFloat(formData.materials) || 0);

        // Add estimated materials from photos
        formData.rooms.forEach(room => {
          const mat = room.estimatedMaterials;
          totalMaterialsCost += mat.boxes * rates.boxCost;
          totalMaterialsCost += mat.bubbleWrapFeet * rates.bubbleWrapCostPerFoot;
          totalMaterialsCost += mat.paperPadBoxes * rates.paperPadCostPerBox;
          totalMaterialsCost += mat.dishPacks * rates.dishPackCost;
        });

        const laborLow = formData.movers * rates.moverHourly * (parseFloat(formData.hoursLow) || 0);
        const laborHigh = formData.movers * rates.moverHourly * (parseFloat(formData.hoursHigh) || 0);
        const vehicleLow = formData.vehicles * rates.vehicleFlat + formData.mileage * rates.mileageRate;
        const vehicleHigh = vehicleLow * 1.2;
        const packingCost = formData.packing ? rates.packingFee : 0;
        const itemCost = totalItems * rates.itemHandling;
        const low = (laborLow + vehicleLow + packingCost + itemCost + totalMaterialsCost).toFixed(2);
        const high = (laborHigh + vehicleHigh + packingCost + itemCost + totalMaterialsCost).toFixed(2);
        return { low, high };
      };

      // Generate PDF quote
      const generatePDF = () => {
        const { low, high } = calculateEstimate();
        const doc = new jsPDF();
        doc.text(`Quote for ${formData.clientName}`, 10, 10);
        doc.text(`Total Estimate: $${low} - $${high}`, 10, 20);
        doc.text(`Number of Movers: ${formData.movers}`, 10, 30);
        doc.text(`Labor Hours (Low/High): ${formData.hoursLow}/${formData.hoursHigh}`, 10, 40);
        doc.text(`Number of Vehicles: ${formData.vehicles}`, 10, 50);
        doc.text(`Mileage (miles): ${formData.mileage}`, 10, 60);
        doc.text(`Packing Service: ${formData.packing ? 'Yes' : 'No'}`, 10, 70);
        doc.text(`Additional Materials Cost: $${formData.materials}`, 10, 80);
        doc.text('Rooms and Items:', 10, 90);
        let yPos = 100;
        formData.rooms.forEach((room, rIdx) => {
          doc.text(`${room.name} (${room.width}x${room.length} ft):`, 10, yPos);
          yPos += 10;
          room.items.forEach((item, i) => {
            doc.text(`  - ${item.name}: ${item.width}x${item.length}x${item.height}`, 10, yPos);
            yPos += 10;
          });
          const mat = room.estimatedMaterials;
          doc.text(`  Estimated Materials: ${mat.boxes} boxes, ${mat.bubbleWrapFeet} ft bubble wrap, ${mat.paperPadBoxes} paper pad boxes, ${mat.dishPacks} dish packs`, 10, yPos);
          yPos += 10;
        });
        doc.save(`${formData.clientName}_quote.pdf`);
      };

      // Export to CSV for CRM
      const exportToCSV = () => {
        const { low, high } = calculateEstimate();
        const headers = ['Client Name', 'Number of Movers', 'Labor Hours Low', 'Labor Hours High', 'Number of Vehicles', 'Mileage (miles)', 'Packing Service', 'Materials Cost', 'Total Low', 'Total High', 'Rooms'];
        const roomsStr = formData.rooms.map(room => 
          `${room.name} (${room.width}x${room.length}): Items - ${room.items.map(item => `${item.name} (${item.width}x${item.length}x${item.height})`).join('; ')}; Materials - Boxes: ${room.estimatedMaterials.boxes}, Bubble: ${room.estimatedMaterials.bubbleWrapFeet}ft, Paper Pads: ${room.estimatedMaterials.paperPadBoxes}, Dish Packs: ${room.estimatedMaterials.dishPacks}`
        ).join(' | ');
        const row = [
          formData.clientName,
          formData.movers,
          formData.hoursLow,
          formData.hoursHigh,
          formData.vehicles,
          formData.mileage,
          formData.packing,
          formData.materials,
          low,
          high,
          roomsStr,
        ];
        const csv = [headers.join(','), row.join(',')].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${formData.clientName}_assessment.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };

      // Draw 2D room visualization for selected room
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const scale = 10;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const room = formData.rooms[selectedRoomIndex];
        if (!room) return;

        const roomWidth = parseFloat(room.width) * scale || 100;
        const roomLength = parseFloat(room.length) * scale || 100;
        ctx.strokeStyle = 'black';
        ctx.strokeRect(0, 0, roomWidth, roomLength);

        room.items.forEach((item, i) => {
          const width = parseFloat(item.width) * scale || 10;
          const length = parseFloat(item.length) * scale || 10;
          ctx.fillStyle = `hsl(${i * 60}, 50%, 50%)`;
          ctx.fillRect(10 + i * 20, 10 + i * 20, width, length);
          ctx.fillStyle = 'white';
          ctx.fillText(item.name || `Item ${i + 1}`, 12 + i * 20, 20 + i * 20);
        });
      }, [formData.rooms, selectedRoomIndex]);

      return (
        <div className="p-4 max-w-md mx-auto bg-gray-100 min-h-screen">
          <h1 className="text-2xl font-bold mb-4">Assessment App</h1>

          {/* Configuration Settings */}
          <div className="mb-6 p-4 border rounded bg-white">
            <h2 className="text-lg font-semibold mb-2">Configuration Settings</h2>
            <p className="text-sm text-gray-600 mb-2">Adjust rates (saved locally for future use)</p>
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block text-sm font-medium">Mover Hourly Rate ($)</label>
                <input type="number" name="moverHourly" value={rates.moverHourly} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Vehicle Flat Cost ($)</label>
                <input type="number" name="vehicleFlat" value={rates.vehicleFlat} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Mileage Rate ($/mile)</label>
                <input type="number" name="mileageRate" value={rates.mileageRate} onChange={handleRateChange} className="w-full p-2 border rounded" step="0.01" />
              </div>
              <div>
                <label className="block text-sm font-medium">Packing Flat Fee ($)</label>
                <input type="number" name="packingFee" value={rates.packingFee} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Per Item Handling ($)</label>
                <input type="number" name="itemHandling" value={rates.itemHandling} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Base Materials Cost ($)</label>
                <input type="number" name="materialsCost" value={rates.materialsCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Bubble Wrap Cost (/ft)</label>
                <input type="number" name="bubbleWrapCostPerFoot" value={rates.bubbleWrapCostPerFoot} onChange={handleRateChange} className="w-full p-2 border rounded" step="0.01" />
              </div>
              <div>
                <label className="block text-sm font-medium">Box Cost ($)</label>
                <input type="number" name="boxCost" value={rates.boxCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Paper Pad Cost (/box)</label>
                <input type="number" name="paperPadCostPerBox" value={rates.paperPadCostPerBox} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
              <div>
                <label className="block text-sm font-medium">Dish Pack Cost ($)</label>
                <input type="number" name="dishPackCost" value={rates.dishPackCost} onChange={handleRateChange} className="w-full p-2 border rounded" />
              </div>
            </div>
          </div>

          {/* Client Name */}
          <div className="mb-4">
            <label className="block text-sm font-medium">Client Name</label>
            <input
              type="text"
              name="clientName"
              value={formData.clientName}
              onChange={handleInputChange}
              className="w-full p-2 border rounded"
              placeholder="Enter client name"
            />
          </div>

          {/* Rooms Section */}
          <div className="mb-4">
            <h2 className="text-lg font-semibold mb-2">Rooms in New Space</h2>
            {formData.rooms.map((room, roomIndex) => (
              <div key={roomIndex} className="mb-4 p-4 border rounded bg-white">
                <input
                  type="text"
                  name="name"
                  value={room.name}
                  onChange={(e) => handleInputChange(e, roomIndex)}
                  className="w-full p-2 border rounded mb-2"
                  placeholder="Room Name (e.g., Living Room)"
                />
                <div className="flex gap-2 mb-2">
                  <input
                    type="number"
                    name="width"
                    value={room.width}
                    onChange={(e) => handleInputChange(e, roomIndex)}
                    className="w-1/2 p-2 border rounded"
                    placeholder="Width (ft)"
                  />
                  <input
                    type="number"
                    name="length"
                    value={room.length}
                    onChange={(e) => handleInputChange(e, roomIndex)}
                    className="w-1/2 p-2 border rounded"
                    placeholder="Length (ft)"
                  />
                </div>

                {/* Photo Upload for Room */}
                <div className="mb-2">
                  <label className="block text-sm font-medium">Upload Room Photo</label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => handlePhotoUpload(e, roomIndex)}
                    className="w-full p-2 border rounded"
                  />
                  {room.photo && <img src={room.photo} alt="Room" className="mt-2 w-full h-40 object-cover rounded" />}
                </div>

                {/* Estimated Materials Display */}
                <div className="mb-2 text-sm">
                  Estimated Materials: {room.estimatedMaterials.boxes} boxes, {room.estimatedMaterials.bubbleWrapFeet} ft bubble wrap, {room.estimatedMaterials.paperPadBoxes} paper pad boxes, {room.estimatedMaterials.dishPacks} dish packs
                </div>

                {/* Furniture Items for this Room */}
                <h3 className="text-md font-medium mb-1">Furniture Items</h3>
                {room.items.map((item, itemIndex) => (
                  <div key={itemIndex} className="mb-2 p-2 border rounded">
                    <input
                      type="text"
                      placeholder="Item name"
                      value={item.name}
                      onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'name')}
                      className="w-full p-1 mb-1 border rounded"
                    />
                    <div className="flex gap-2">
                      <input
                        type="number"
                        placeholder="Width (ft)"
                        value={item.width}
                        onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'width')}
                        className="w-1/3 p-1 border rounded"
                      />
                      <input
                        type="number"
                        placeholder="Length (ft)"
                        value={item.length}
                        onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'length')}
                        className="w-1/3 p-1 border rounded"
                      />
                      <input
                        type="number"
                        placeholder="Height (ft)"
                        value={item.height}
                        onChange={(e) => handleInputChange(e, roomIndex, itemIndex, 'height')}
                        className="w-1/3 p-1 border rounded"
                      />
                    </div>
                  </div>
                ))}
                <button
                  onClick={() => addItemToRoom(roomIndex)}
                  className="bg-blue-500 text-white px-4 py-2 rounded mt-2"
                >
                  Add Item to {room.name || 'this Room'}
                </button>
              </div>
            ))}
            <button
              onClick={addRoom}
              className="bg-green-500 text-white px-4 py-2 rounded"
            >
              Add New Room
            </button>
          </div>

          {/* Estimate Inputs */}
          <div className="mb-4">
            <h2 className="text-lg font-semibold">Estimate Details</h2>
            <div className="grid grid-cols-2 gap-2">
              <div>
                <label className="block text-sm font-medium">Number of Movers</label>
                <input
                  type="number"
                  name="movers"
                  value={formData.movers}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Movers"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Number of Vehicles</label>
                <input
                  type="number"
                  name="vehicles"
                  value={formData.vehicles}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Vehicles"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Labor Hours Low</label>
                <input
                  type="number"
                  name="hoursLow"
                  value={formData.hoursLow}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Low Hours"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Labor Hours High</label>
                <input
                  type="number"
                  name="hoursHigh"
                  value={formData.hoursHigh}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="High Hours"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Mileage (miles)</label>
                <input
                  type="number"
                  name="mileage"
                  value={formData.mileage}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Mileage"
                />
              </div>
              <div>
                <label className="block text-sm font-medium">Additional Materials Cost ($)</label>
                <input
                  type="number"
                  name="materials"
                  value={formData.materials}
                  onChange={handleInputChange}
                  className="w-full p-2 border rounded"
                  placeholder="Materials"
                />
              </div>
            </div>
            <label className="flex items-center mt-2">
              <input
                type="checkbox"
                name="packing"
                checked={formData.packing}
                onChange={(e) => setFormData({ ...formData, packing: e.target.checked })}
                className="mr-2"
              />
              Packing Service Needed
            </label>
          </div>

          {/* Room Visualization */}
          <div className="mb-4">
            <h2 className="text-lg font-semibold">Room Visualization</h2>
            <select
              value={selectedRoomIndex}
              onChange={(e) => setSelectedRoomIndex(parseInt(e.target.value))}
              className="w-full p-2 border rounded mb-2"
            >
              {formData.rooms.map((room, index) => (
                <option key={index} value={index}>
                  {room.name || `Room ${index + 1}`}
                </option>
              ))}
            </select>
            <canvas ref={canvasRef} width="300" height="300" className="w-full"></canvas>
            <p className="text-sm text-gray-600">Preview of items in selected room (colored rectangles).</p>
          </div>

          {/* Estimate and Actions */}
          <div className="mb-4">
            <h2 className="text-lg font-semibold">Estimate: ${calculateEstimate().low} - ${calculateEstimate().high}</h2>
            <div className="flex gap-2">
              <button
                onClick={generatePDF}
                className="bg-green-500 text-white px-4 py-2 rounded"
              >
                Download Quote PDF
              </button>
              <button
                onClick={exportToCSV}
                className="bg-gray-500 text-white px-4 py-2 rounded"
              >
                Export to CSV
              </button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>